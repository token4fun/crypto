<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SHERK Real-Time Chart</title>

  <!-- 1) Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"></script>

  <!-- 2) graphql-ws (ESM build) from jsDelivr -->
  <!-- This provides createClient() for subscriptions -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/graphql-ws@5.12.0/esm/index.js';

    // -------------------------
    // A) Your subscription query
    // -------------------------
    const SUBSCRIPTION_QUERY = `
      subscription ($token: String, $time_ago: DateTime) {
        Solana {
          DEXTradeByTokens(
            orderBy: { ascendingByField: "Block_Time" }
            where: {
              Trade: {
                Currency: { MintAddress: { is: $token } }, 
                Side: {
                  Currency: {
                    MintAddress: {
                      in: [
                        "11111111111111111111111111111111", 
                        "So11111111111111111111111111111111111111112", 
                        "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v", 
                        "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB", 
                        "JUPyiwrYJFskUPiHa7hkeR8VUtAeFoSYbKedZNsDvCN", 
                        "EKpQGSJtjMFqKZ9KQanSqYXRcF8fBopzLHYxdM65zcjm"
                      ]
                    }
                  }
                }
              }, 
              Block: { Time: { after: $time_ago } }
            }
          ) {
            Block {
              Time
            }
            Trade {
              close: PriceInUSD(maximum: Transaction_Index)
            }
            min: quantile(of: Trade_PriceInUSD, level: 0.05)
            max: quantile(of: Trade_PriceInUSD, level: 0.95)
            volume: sum(of: Trade_Side_AmountInUSD)
          }
        }
      }
    `;

    // -----------------------------
    // B) Variables for the query
    // -----------------------------
    const VARIABLES = {
      token: "6wY93bkRSk5KagCGTHrjLPCpbMWEPQGU9wrpsZ8tyftL",
      time_ago: "2025-01-24T11:02:40Z"
    };

    // -----------------------------------------
    // C) Create a client for the Bitquery WS
    //    (Adjust URL / authentication as needed)
    // -----------------------------------------
    const client = createClient({
      url: 'wss://streaming.bitquery.io/eap',
      // If Bitquery requires authentication (headers), do something like:
      // connectionParams: {
      //   token: 'YOUR_BITQUERY_API_KEY',
      // },
    });

    // -------------------
    // D) Initialize Chart
    // -------------------
    let myChart;
    window.addEventListener('DOMContentLoaded', () => {
      const ctx = document.getElementById('myChart').getContext('2d');
      myChart = new Chart(ctx, {
        type: 'line', // using a line chart for simplicity
        data: {
          labels: [],     // will hold timestamps
          datasets: [{
            label: 'SHERK Real-Time Price (USD)',
            data: [],      // will hold the "close" price
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            fill: true
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              title: { display: true, text: 'Time' },
              type: 'time',       // Chart.js timescale
              time: {
                unit: 'minute',   // Adjust to 'second', 'hour', etc. if you want
                displayFormats: {
                  minute: 'MMM d, HH:mm'
                }
              }
            },
            y: {
              title: { display: true, text: 'Price (USD)' },
              beginAtZero: false
            }
          }
        }
      });

      // -----------------------------------------------------------
      // E) Subscribe to real-time data + update chart on each event
      // -----------------------------------------------------------
      client.subscribe(
        { query: SUBSCRIPTION_QUERY, variables: VARIABLES },
        {
          next: (payload) => {
            // payload contains data from the subscription
            // e.g. data.data.Solana.DEXTradeByTokens
            const items = payload?.data?.Solana?.DEXTradeByTokens;
            if (!Array.isArray(items) || items.length === 0) return;

            // For demonstration, let's assume each "item" is a single data point
            // (In reality, you might get multiple items or partial updates.)
            items.forEach((item) => {
              const closePrice = item?.Trade?.close;
              const time = item?.Block?.Time;
              if (time && closePrice) {
                // Push new data into the chart
                myChart.data.labels.push(time);
                myChart.data.datasets[0].data.push(closePrice);
              }
            });

            // Re-render the chart
            myChart.update();
          },
          error: (err) => {
            console.error('Subscription error:', err);
          },
          complete: () => {
            console.log('Subscription completed');
          },
        }
      );
    });
  </script>

  <style>
    body {
      margin: 0; 
      padding: 0;
      background: #f0f0f0;
      font-family: Arial, sans-serif;
    }
    .chart-container {
      width: 800px;
      max-width: 95%;
      margin: 40px auto;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
    }
  </style>

</head>
<body>
  <div class="chart-container">
    <canvas id="myChart" width="800" height="400"></canvas>
  </div>
</body>
</html>
